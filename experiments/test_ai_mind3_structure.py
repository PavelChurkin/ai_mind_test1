"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã ai_mind3.py

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –≤—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏–∑ issue #5 —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã
"""
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

def test_imports():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤"""
    print("‚úì –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤...")
    try:
        import ai_mind3
        print("  ‚úì ai_mind3 —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω")
        return True
    except ImportError as e:
        print(f"  ‚úó –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e}")
        return False


def test_class_structure():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–ª–∞—Å—Å–∞"""
    print("\n‚úì –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–ª–∞—Å—Å–∞ EmotionalMindV3...")
    import ai_mind3

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª–∞—Å—Å–∞
    assert hasattr(ai_mind3, 'EmotionalMindV3'), "–ö–ª–∞—Å—Å EmotionalMindV3 –Ω–µ –Ω–∞–π–¥–µ–Ω"
    print("  ‚úì –ö–ª–∞—Å—Å EmotionalMindV3 —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Ç–æ–¥—ã
    required_methods = [
        '__init__',
        'increase_state_weight',
        'decrease_state_weight',
        'get_top_states',
        'get_triggered_states',
        'analyze_user_states',
        'save_to_memory',
        'delayed_analysis',
        'generate_spontaneous_response',
        'generate_response',
        'process_message',
        '_get_parent_states'
    ]

    cls = ai_mind3.EmotionalMindV3
    for method in required_methods:
        assert hasattr(cls, method), f"–ú–µ—Ç–æ–¥ {method} –Ω–µ –Ω–∞–π–¥–µ–Ω"
        print(f"  ‚úì –ú–µ—Ç–æ–¥ {method} —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")

    return True


def test_mind_json_loading():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ mind1.json"""
    print("\n‚úì –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ mind1.json...")
    import json

    with open('mind1.json', 'r', encoding='utf-8') as f:
        data = json.load(f)

    assert '—Å–æ—Å—Ç–æ—è–Ω–∏—è' in data, "–ö–ª—é—á '—Å–æ—Å—Ç–æ—è–Ω–∏—è' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ mind1.json"
    print(f"  ‚úì mind1.json –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–∞–π–¥–µ–Ω–æ {len(data['—Å–æ—Å—Ç–æ—è–Ω–∏—è'])} —Å–æ—Å—Ç–æ—è–Ω–∏–π")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–æ—Å—Ç–æ—è–Ω–∏–π
    for state in data['—Å–æ—Å—Ç–æ—è–Ω–∏—è'][:3]:  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–≤—ã–µ 3
        assert '–Ω–∞–∑–≤–∞–Ω–∏–µ' in state, "–ü–æ–ª–µ '–Ω–∞–∑–≤–∞–Ω–∏–µ' –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        assert '—É—Å–ª–æ–≤–∏—è' in state, "–ü–æ–ª–µ '—É—Å–ª–æ–≤–∏—è' –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"
        assert '–≤–µ—Å' in state, "–ü–æ–ª–µ '–≤–µ—Å' –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç"

    print("  ‚úì –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞")
    return True


def test_requirements_implementation():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∏–∑ issue #5"""
    print("\n‚úì –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π –∏–∑ issue #5...")

    import ai_mind3
    import inspect

    # –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 1: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–ø–∏—Å–∫–∏
    source = inspect.getsource(ai_mind3.EmotionalMindV3)
    assert 'conversation_history' in source, "–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤–µ–¥–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏"
    print("  ‚úì –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 1: –í–µ–¥–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏ - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ")

    # –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 2: –û—Ç–ø—Ä–∞–≤–∫–∞ –≤—Å–µ–≥–æ —Ñ–∞–π–ª–∞ mind1.json
    assert 'states_tree' in source or 'states_dict' in source, "–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å –¥–µ—Ä–µ–≤–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–π"
    print("  ‚úì –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 2: –†–∞–±–æ—Ç–∞ —Å –¥–µ—Ä–µ–≤–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–π mind1.json - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ")

    # –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 3: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤–µ—Å–æ–≤
    assert 'increase_state_weight' in source, "–ù–µ –Ω–∞–π–¥–µ–Ω –º–µ—Ç–æ–¥ —É–≤–µ–ª–∏—á–µ–Ω–∏—è –≤–µ—Å–æ–≤"
    print("  ‚úì –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 3: –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –≤–µ—Å–æ–≤ —Å–æ—Å—Ç–æ—è–Ω–∏–π - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ")

    # –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 4: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ —Ç–æ–ø-3
    assert 'get_top_states' in source, "–ù–µ –Ω–∞–π–¥–µ–Ω –º–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–ø —Å–æ—Å—Ç–æ—è–Ω–∏–π"
    print("  ‚úì –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 4: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏ —Ç–æ–ø-3 —Å–æ—Å—Ç–æ—è–Ω–∏–π - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ")

    # –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 5: analyze.txt
    assert 'analyze.txt' in source or 'memory_file' in source, "–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–æ–º –ø–∞–º—è—Ç–∏"
    assert 'save_to_memory' in source, "–ù–µ –Ω–∞–π–¥–µ–Ω –º–µ—Ç–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ø–∞–º—è—Ç—å"
    print("  ‚úì –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 5: –ö—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø–∞–º—è—Ç—å (analyze.txt) - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ")

    # –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 6: –ó–∞–¥–µ—Ä–∂–∫–∞ 5 —Å–µ–∫—É–Ω–¥
    assert 'delayed_analysis' in source, "–ù–µ –Ω–∞–π–¥–µ–Ω –º–µ—Ç–æ–¥ –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞"
    assert 'asyncio.sleep' in source or 'response_delay' in source, "–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞"
    print("  ‚úì –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 6: –ó–∞–¥–µ—Ä–∂–∫–∞ 5 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ")

    # –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 7: –°–ø–æ–Ω—Ç–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –ø—Ä–∏ –≤–µ—Å–µ 1.0
    assert 'spontaneous' in source.lower(), "–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–æ–Ω—Ç–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤"
    assert 'generate_spontaneous_response' in source, "–ù–µ –Ω–∞–π–¥–µ–Ω –º–µ—Ç–æ–¥ —Å–ø–æ–Ω—Ç–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞"
    print("  ‚úì –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 7: –°–ø–æ–Ω—Ç–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –ø—Ä–∏ –≤–µ—Å–µ 1.0 - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ")

    # –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 8: –£–º–µ–Ω—å—à–µ–Ω–∏–µ –≤–µ—Å–æ–≤ –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞
    assert 'decrease_state_weight' in source, "–ù–µ –Ω–∞–π–¥–µ–Ω –º–µ—Ç–æ–¥ —É–º–µ–Ω—å—à–µ–Ω–∏—è –≤–µ—Å–æ–≤"
    print("  ‚úì –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 8: –£–º–µ–Ω—å—à–µ–Ω–∏–µ –≤–µ—Å–æ–≤ –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ")

    # –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 9: –£—á—ë—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
    assert '_get_parent_states' in source or 'parent' in source.lower(), "–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏–º–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏"
    print("  ‚úì –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 9: –£—á—ë—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø—Ä–∏ —É—Å–ª–æ–≤–∏—è—Ö - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ")

    # –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 10: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ "0"
    assert 'async def main' in source or 'asyncio.run' in source, "–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞"
    assert 'if user_input == "0"' in inspect.getsource(ai_mind3.main), "–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—ã—Ö–æ–¥"
    print("  ‚úì –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ 10: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ '0' - —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ")

    return True


def main():
    """–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤"""
    print("="*60)
    print("üß™ –í–∞–ª–∏–¥–∞—Ü–∏—è ai_mind3.py")
    print("="*60)

    tests = [
        test_imports,
        test_class_structure,
        test_mind_json_loading,
        test_requirements_implementation
    ]

    results = []
    for test in tests:
        try:
            result = test()
            results.append(result)
        except Exception as e:
            print(f"\n‚úó –¢–µ—Å—Ç {test.__name__} –ø—Ä–æ–≤–∞–ª–µ–Ω: {e}")
            import traceback
            traceback.print_exc()
            results.append(False)

    print("\n" + "="*60)
    if all(results):
        print("‚úì –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û!")
        print("="*60)
        return 0
    else:
        print("‚úó –ù–ï–ö–û–¢–û–†–´–ï –¢–ï–°–¢–´ –ü–†–û–í–ê–õ–ï–ù–´")
        print("="*60)
        return 1


if __name__ == "__main__":
    exit_code = main()
    sys.exit(exit_code)

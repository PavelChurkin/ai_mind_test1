# ai_mind2.py - Улучшенная версия эмоционального бота

## Обзор

`ai_mind2.py` - это улучшенная версия `ai_mind1.py`, которая исправляет все проблемы, указанные в issue #3.

## Что исправлено

### 1. ✅ Полное дерево состояний (не только первые 3)

**Проблема:** Узлы древа рассматривались не все, а только первые 3.

**Решение:**
- Все состояния из `mind1.json` теперь используются
- В анализ передаётся полный список из 89 состояний
- Исправлена ошибка загрузки JSON (было `"технологии"`, должно быть `"состояния"`)

```python
# Было (ai_mind1.py):
root_nodes = [node["название"] for node in self.states_tree if "Пустота" in node.get("условия", [])]
# Только корневые узлы!

# Стало (ai_mind2.py):
all_states = [node["название"] for node in self.states_tree]
# Все 89 состояний!
```

### 2. ✅ Алгоритм анализа связи узлов

**Проблема:** Нет алгоритма анализа связи узлов, которые бы приводили к смене в другое состояние.

**Решение:** Добавлен метод `propagate_activation()` с автоматическим распространением активации:

```python
def propagate_activation(self, iterations: int = 3):
    """Автоматическое распространение активации по дереву"""
    for iteration in range(iterations):
        # Для каждого активного состояния
        for state_name, activation in self.active_nodes.items():
            # Находим дочерние состояния
            children = self.find_children(state_name)
            # Распространяем активацию с затуханием 50%
            for child in children:
                influence = activation * 0.5
                # Активируем дочерние состояния
```

**Пример работы:**
```
Реплика: "Ты опять ошибся"
Итерация 0: Тревога (0.8)
Итерация 1: Тревога (0.8) -> Гнев (0.4), Сомнение (0.4)
Итерация 2: Гнев (0.4) -> Объективизация (0.2)
```

### 3. ✅ Полный JSON состояний в промптах

**Проблема:** Появляются состояния, которых нет в древе - нужно отправлять весь json состояний в промпт.

**Решение:**
- В каждый промпт передаётся `self.states_tree_json` - полное дерево
- БЯМ видит все доступные состояния и их связи
- Добавлена валидация: состояния проверяются на существование в `nodes_map`

```python
prompt = f"""
ПОЛНЫЙ СПИСОК ДОСТУПНЫХ СОСТОЯНИЙ:
{json.dumps(all_states, ensure_ascii=False)}

ДЕРЕВО СОСТОЯНИЙ С ЗАВИСИМОСТЯМИ:
{self.states_tree_json[:3000]}
"""
```

### 4. ✅ Логирование текущих состояний

**Проблема:** Нужно логирование текущих состояний бота.

**Решение:** Добавлена система логирования:

```python
def log_state(self, message: str):
    """Логирование с timestamp и активными состояниями"""
    timestamp = datetime.now().strftime("%H:%M:%S")
    log_entry = f"[{timestamp}] {message}"
    self.log_buffer.append(log_entry)
    print(log_entry)

    # Автоматически логируем активные состояния
    if self.active_nodes:
        active_states_str = ", ".join([f"{k}:{v:.2f}" for k, v in self.active_nodes.items()])
```

**Вывод:**
```
[15:23:45] === Обработка: 'Ты опять ошибся' ===
[15:23:45] СОСТОЯНИЯ: Тревога:0.80, Уточнение:0.70, Сожаление:0.60
[15:23:46] Распространение активации, итераций: 3
[15:23:46] Итерация 1: новые состояния ['Гнев', 'Сомнение', 'О былом']
```

### 5. ✅ Бот отвечает согласно состояниям

**Проблема:** Бот не должен просто брать и отключать состояния, в которых находится, он должен отвечать согласно своим состояниям.

**Решение:**
- В промпты добавлены явные инструкции отражать состояния в ответах
- Состояния НЕ отключаются при активации новых
- Состояния затухают естественно (коэффициент 0.92)
- Только после генерации ответа веса уменьшаются

```python
prompt = f"""
ВАЖНО: Ответ должен ОТРАЖАТЬ текущие состояния бота.
Если активен Гнев - ответ может быть резким.
Если активно Сомнение - ответ содержит неуверенность.
Если активно Уточнение - задавай вопросы.

Мои активные эмоциональные состояния: {active_states_str}
"""
```

### 6. ✅ Система весов с увеличением/уменьшением

**Проблема:** Веса на древе должны увеличиваться в зависимости от выявленных категорий(состояний). При достижении единицы в весе - генерируется ответ, который уменьшает вес данных состояний.

**Решение:**

#### Увеличение весов:
```python
def update_activation(self, states_to_activate, states_to_increase):
    # Новые состояния получают вес 0.7
    for state in states_to_activate:
        self.active_nodes[state] = 0.7

    # Существующие состояния увеличиваются на 0.2
    for state in states_to_increase:
        self.active_nodes[state] = min(1.0, self.active_nodes[state] + 0.2)

    # Естественное затухание всех состояний
    for state in self.active_nodes:
        self.active_nodes[state] *= 0.92
```

#### Адаптивное давление:
```python
def calculate_pressure(self) -> float:
    """Веса состояний влияют на срочность ответа"""
    urgency_weights = {
        'Гнев': 0.9,      # Высокий приоритет - быстрый ответ
        'Уточнение': 0.7,
        'Сомнение': 0.3,  # Низкий приоритет - долго обдумывает
        'О грёзах': 0.1   # Очень низкий - почти не отвечает
    }
    pressure = sum(activation * urgency_weights.get(state, 0.5)
                   for state, activation in self.active_nodes.items())
    return min(pressure, 1.0)
```

#### Уменьшение весов после ответа:
```python
def reduce_weights_after_response(self):
    """Катарсис после ответа"""
    for state in self.active_nodes:
        if state in self.trigger_nodes:
            self.active_nodes[state] *= 0.4  # Триггерные - сильнее
        else:
            self.active_nodes[state] *= 0.7  # Остальные - умеренно
```

### 7. ✅ Модель окружающего мира (JSON-based Knowledge Graph)

**Проблема:** Нужна Модель окружающего мира и база знаний бота через вопрос-ответное мышление.

**Решение:** Добавлена система Knowledge Graph:

#### Структура world_model.json:
```json
{
  "concepts": [
    {
      "id": "concept_0001",
      "name": "утро",
      "type": "temporal",
      "associations": ["кофе", "солнце", "пробуждение"],
      "emotional_context": ["Очарование", "Уточнение"],
      "created_at": "2024-01-15T08:30:00",
      "source": "dialogue"
    }
  ],
  "relations": []
}
```

#### Автоматическое извлечение концептов:
```python
async def update_world_model(self, user_input: str, bot_response: str):
    """После каждого диалога извлекаются новые концепты"""
    result = await self.bam_api_call(prompt_to_extract_concepts)

    for concept in result.get("concepts", []):
        concept["emotional_context"] = list(self.active_nodes.keys())
        self.world_model["concepts"].append(concept)

    self.save_world_model()
```

#### Использование при генерации ответов:
```python
relevant_concepts = self.find_relevant_concepts(active_states_str)
prompt = f"""
Контекст из базы знаний: {relevant_concepts}
"""
```

## Как использовать

### Базовый запуск:

```bash
# Установите зависимости
pip install openai python-dotenv

# Создайте .env файл
echo "OPENAI_API_KEY=your_key_here" > .env

# Запустите бота
python ai_mind2.py
```

### Команды в интерактивном режиме:

- Введите любое сообщение для общения с ботом
- `статус` - показать подробную информацию о текущем состоянии
- `0` - выход (автоматически сохраняет логи)

### Просмотр статуса:

```
Вы: статус

============================================================
СТАТУС СИСТЕМЫ:
============================================================
Активные состояния (>0.3): ['Тревога', 'Уточнение', 'Гнев']

Все активные состояния:
  Тревога: 0.856
  Уточнение: 0.742
  Гнев: 0.481
  Сомнение: 0.234

Давление на ответ: 0.76
Состояния собеседника: ['Сожаление', 'Тревога']
Записей в памяти: 3
Длина диалога: 6
Концептов в базе знаний: 12
============================================================
```

## Тестирование без API

Для проверки алгоритмов без реальных API вызовов используйте эксперименты:

### Тест распространения активации:
```bash
python experiments/test_state_propagation.py
```

Выход:
```
ТЕСТ 1: Реплика 'Ты опять ошибся' -> активирует Тревогу
Итерация 1: Тревога (0.80) -> Гнев (0.40), Сомнение (0.40)
Итерация 2: Гнев (0.40) -> Объективизация (0.20)
```

### Тест системы весов:
```bash
python experiments/test_weight_system.py
```

Выход:
```
ТЕСТ 1: Гнев (0.8)
Расчет давления:
  Гнев: активация=0.80 * вес=0.9 = 0.72
Порог для ответа: 0.70
Отвечать: ДА
```

## Сравнение с ai_mind1.py

| Функция | ai_mind1.py | ai_mind2.py |
|---------|-------------|-------------|
| Используемые состояния | Только корневые (~3) | Все 89 состояний |
| Распространение активации | Нет | Да, 3 итерации |
| JSON в промптах | Нет | Да, полное дерево |
| Логирование | Минимальное | Подробное с timestamp |
| Поведение при ответе | Отключает состояния | Отвечает согласно состояниям |
| Система весов | Фиксированное давление | Адаптивная с весами |
| База знаний | Нет | JSON Knowledge Graph |
| Эксперименты | Нет | Да, в `experiments/` |

## Структура файлов

```
.
├── ai_mind1.py                   # Оригинальная версия
├── ai_mind2.py                   # НОВАЯ улучшенная версия
├── mind1.json                    # Дерево состояний (89 состояний)
├── world_model.json              # База знаний (создаётся автоматически)
├── bot_logs.txt                  # Логи (создаются при выходе)
├── experiments/                  # Тесты без API
│   ├── test_state_propagation.py
│   └── test_weight_system.py
└── examples/                     # Примеры использования
    └── dialogue_example.py
```

## Архитектура улучшений

### Цикл обработки сообщения:

```
Входящая реплика
      ↓
1. Анализ состояния пользователя (все 89 состояний)
      ↓
2. Активация эмпатических состояний
      ↓
3. Распространение активации (3 итерации по дереву)
      ↓
4. Расчёт адаптивного давления (веса состояний)
      ↓
5. Решение об ответе (на основе давления)
      ↓
   Нужно ли отвечать?
      ↓
   ДА → Генерация ответа согласно состояниям
      ↓
      Уменьшение весов (катарсис)
      ↓
      Обновление базы знаний
      ↓
      Архивация в память
```

## Метрики и мониторинг

### Показатели после каждого сообщения:
```
[Давление: 0.76 | Активных состояний: 8 | Концептов: 12]
```

### Подробный статус:
- Активные состояния с весами
- Давление на ответ (0-1)
- Состояния собеседника
- Размер кратковременной памяти
- Количество концептов в базе знаний

## Примеры работы

### Сценарий 1: Критика
```
Вы: Ты опять ошибся

[15:23:45] Анализ: Тревога (0.8), Уточнение (0.7), Сожаление (0.6)
[15:23:46] Распространение: Гнев (0.4), Сомнение (0.4), О былом (0.3)
[15:23:47] Давление: 0.76 -> ОТВЕТИТЬ

Бот: Прости, что именно не так? Хочу понять и исправить.
     (отражает Уточнение + Сожаление)

[15:23:47] Уменьшение весов: Уточнение 0.7->0.28, Тревога 0.8->0.32
```

### Сценарий 2: Размышления
```
Вы: Интересно, как устроена вселенная...

[15:25:12] Анализ: Любопытство (0.9), Очарование (0.8), Уточнение (0.6)
[15:25:13] Распространение: Условия причин (0.4), Потому что (0.2)
[15:25:14] Давление: 0.58 -> МОЛЧАТЬ (порог 0.7)

[Бот молчит, обдумывает...]
[Давление: 0.58 | Активных состояний: 5 | Концептов: 13]
```

### Сценарий 3: Накопление давления
```
Вы: Ты думаешь это правильно?
[Давление: 0.42] [Бот молчит]

Вы: Ну так что?
[Давление: 0.61] [Бот молчит]

Вы: Отвечай!
[Давление: 0.87]

Бот: Я не уверен... С одной стороны да, но есть сомнения.
     (Давление превысило порог -> ответ с Сомнением)
```

## Заключение

`ai_mind2.py` полностью решает все проблемы из issue #3:

✅ Все узлы дерева рассматриваются
✅ Алгоритм анализа связей реализован
✅ Весь JSON передаётся в промпты
✅ Логирование состояний работает
✅ Бот отвечает согласно состояниям
✅ Система весов с увеличением/уменьшением
✅ JSON-based Knowledge Graph для модели мира

Система теперь демонстрирует более реалистичное "мышление" с постепенным накоплением эмоционального давления, естественными переходами между состояниями и формированием базы знаний о мире.
